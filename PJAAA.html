<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>Quiz Practice - 4 Sets</title>
<style>
  .checkbox-level2 input[type="checkbox"] {
    transition: transform 0.2s;
    accent-color: #B3E0F6;
    background-color: #B3E0F6;
    border-color: #B3E0F6;
  }
/* Ngăn scale khi tap trên mobile */
.checkbox-level2 input[type="checkbox"]:active {
  transform: none !important;
}
 
  body { font-family: Arial, sans-serif; display: flex; justify-content: center; padding: 20px; background: #f9fafb; font-size: 0.95em; }
.container { width: 80%; max-width: 700px; }
.box-level1 { border: 2px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px; background: #fff; }
  .box-level1 h2 { margin: 0 0 10px 0; font-size: 0.95em; cursor: pointer; user-select: none; }
.box-content { margin-top: 10px; }
  .checkbox-level2 { display: block; width: 100%; padding: 4px 10px; margin: 2px 0; border: 1px solid #aaa; border-radius: 20px; cursor: pointer; transition: all 0.2s; box-sizing: border-box; min-height: 28px; font-size: 0.95em; }
/* .checkbox-level2:hover { transform: scale(0.995); background-color: #f1f5f9; } */
.controls-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
.controls-row label { margin-right: 10px; }
.button-row { display: flex; justify-content: space-between; margin: 10px 0; gap: 10px; flex-wrap: wrap; }
button { padding: 6px 14px; border: none; border-radius: 8px; cursor: pointer; background: #2563eb; color: white; font-weight: bold; }
button { padding: 6px 14px; border: none; border-radius: 8px; cursor: pointer; background: #B3E0F6; color: #2563eb; font-weight: bold; }
button:hover { background: #90c8e0; }
  .question { margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 0.95em; }
.question p { font-weight: bold; margin: 0 0 10px 0; }
  .option {
  display: flex;
  align-items: stretch;
  margin: 1px 0;
  padding: 2px 8px 2px 0;
  border-radius: 0;
  cursor: pointer;
  transition: background 0.2s;
  font-size: 0.95em;
  line-height: 1.15;
  min-height: 1.25em;
  }
/* Dải màu đậm bên trái đáp án */
.option-mark {
  width: 0;
  height: 100%;
  background: transparent;
  border-radius: 2px 0 0 2px;
  box-shadow: 0 0 2px rgba(0,0,0,0.08);
  margin-right: 8px;
  flex-shrink: 0;
  transition: width 0.2s, background 0.2s;
}
.option.correct .option-mark {
  background: #10b981;
  width: 8px;
}
.option.correct.wrong-selected .option-mark {
  background: #10b981;
  width: 4px;
}
.option.wrong .option-mark {
  background: #ef4444;
  width: 8px;
}
  .option input[type="radio"] {
  margin-right: 10px;
  width: 1em;
  height: 1em;
  border-radius: 50%;
  border: none;
  background: #fff;
  box-shadow: none;
  }
  .option input[type="radio"]:checked {
    background: #fff;
  }
  .option.correct input[type="radio"]:checked {
    background: #d1fae5;
  }
  .option.wrong input[type="radio"]:checked {
    background: #fee2e2;
  }
  }
  .option.correct input[type="radio"],
  .option.wrong input[type="radio"] {
    box-shadow: none;
  }
  }
.option:hover { background: #f1f5f9; }
.option.correct { background: #d1fae5; border: none; border-radius: 0; }
.option.wrong { background: #fee2e2; border: none; border-radius: 0; }
.collapsible { max-height: 200px; overflow-y: auto; transition: max-height 0.3s ease; }
.collapsed { display: none; }
.flag-checkbox {
  margin-right: 0;
  cursor: pointer;
  border: none;
  background: none;
  padding: 0;
  font-size: 1.2em;
  color: #eab308;
  display: flex;
  align-items: center;
}
.flag-round {
    transition: background 0.2s;
    width: 1.2em;
    height: 1.2em;
    border-radius: 4px;
    background: #fecaca;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.07);
    margin-right: 8px;
    margin-left: 0;
  }
  .flag-round.flag-active {
    background: #B3E0F6 !important;
    box-shadow: 0 2px 6px rgba(179,224,246,0.25);
  }
.flag-container {
  margin-bottom: 10px;
  display: flex;
  align-items: center;
}

@media (max-width: 600px) {
}

@media (max-width: 430px) {
  body { padding: 0.5vw; }
  .container { padding: 0 0.5vw; }
  .box-level1 { padding: 0.3rem 0.3rem 0.7rem 0.3rem; border-radius: 0.35rem; margin-bottom: 0.7rem; }
  .box-level1 h2 { font-size: 0.95rem; }
  .checkbox-level2 { font-size: 0.85rem; padding: 0.18rem 0.3rem; min-height: 1.2rem; }
  .checkbox-level2 input[type="checkbox"] {
    min-width: 1rem;
    min-height: 1rem;
    width: 1rem;
    height: 1rem;
  }
  .controls-row label, .controls-row input {
    font-size: 0.85rem;
  }
  .controls-row input[type="number"] {
    padding: 0.18rem;
    width: 1.7rem;
  }
  button {
    font-size: 0.85rem;
    padding: 0.3rem 0.7rem;
    border-radius: 0.35rem;
  }
  .question { padding: 0.3rem; font-size: 0.85rem; border-radius: 0.35rem; }
  .option { font-size: 0.85rem; padding: 0.3rem; }
  .option input[type="radio"] {
    width: 0.8rem;
    height: 0.8rem;
  }
  #questionCount { font-size: 0.9em; }
  body { padding: 1vw; }
  .container { width: 100%; max-width: 100vw; padding: 0 1vw; }
  .box-level1 { padding: 0.5rem 0.5rem 1rem 0.5rem; border-radius: 0.5rem; margin-bottom: 1rem; }
  .box-level1 h2 { font-size: 1.1rem; }
  .checkbox-level2 { font-size: 1rem; padding: 0.3rem 0.5rem; min-height: 1.7rem; }
  .checkbox-level2 input[type="checkbox"] {
    min-width: 1.2rem;
    min-height: 1.2rem;
    width: 1.2rem;
    height: 1.2rem;
  }
  .controls-row label, .controls-row input {
    font-size: 1rem;
  }
  .controls-row input[type="number"] {
    padding: 0.3rem;
    width: 2.5rem;
  }
  button {
    font-size: 1rem;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
  }
  .question { padding: 0.5rem; font-size: 1rem; border-radius: 0.5rem; }
  .option { font-size: 1rem; padding: 0.5rem; }
  .option input[type="radio"] {
    width: 1rem;
    height: 1rem;
  }
  #questionCount { font-size: 1rem; }
}
}

@media (pointer: coarse) {
  /* Tăng kích thước checkbox trên mobile */
  .checkbox-level2 input[type="checkbox"] {
    min-width: 24px;
    min-height: 24px;
  }

  /* Vẫn giữ transform none khi active */
  .checkbox-level2 input[type="checkbox"]:active {
    transform: none !important;
  }
}
  
  
</style>
</head>
<body>
<div class="container">
  <div class="version-bar" style="text-align:center; font-size:0.95em; color:#555; margin-bottom:8px; font-weight:bold;">version 1.1.0</div>

  <!-- Question Sets -->
  <div class="box-level1">

    <h2 onclick="toggleBox('setsBox')">Question Sets ▼</h2>
    <div id="setsBox" class="box-content collapsible"></div>
    <div class="button-row">
      <button onclick="loadSelectedSets()">Load Selected Set</button>
      <!-- Import CSV -->
      <input type="file" id="importCsvInput" accept=".csv" style="margin-top:10px;">
      <button onclick="importCSVFile()" style="margin-top:5px;">Import CSV</button>

    </div>
  </div>

  <!-- Question Range Selection -->
  <div class="box-level1">
    <h2>Question Range Selection</h2>
    <label class="checkbox-level2"><input type="checkbox" id="fixedMode"> Fixed Mode</label>
    <label class="checkbox-level2"><input type="checkbox" id="instantMode"> Instant Check Mode</label>
    <div class="controls-row">
      <label>Start Question: <input type="number" id="startQ" value="1" min="1"></label>
      <label>End Question: <input type="number" id="endQ" value="1" min="1"></label>
      <label>Num. Questions: <input type="number" id="numQ" value="1" min="1"></label>
    </div>
    <div class="button-row">
      <button onclick="showAllQuestions()">All Questions</button>
      <button onclick="refreshQuestions()">Refresh</button>
    </div>
  </div>

  <!-- Flag Controls -->
  <div class="box-level1">
    <h2>Flag Controls</h2>
    <label class="checkbox-level2"><input type="checkbox" id="showFlaggedOnly" onchange="renderQuestions()"> Show Flagged Only</label>
    <div class="button-row">
      <button onclick="exportFlagged()">Export Flagged Questions</button>
      <button onclick="clearAllFlags()">Clear All Flags</button>
    </div>
  </div>
  <div id="questionCount" style="margin-top:5px; font-weight:bold;"></div>

  <!-- Questions Display -->
  <div id="questions"></div>
</div>


<script>
// ======================= Load CSV from files =======================
let questionBanks = {};
let flagStates = {};
let selectedAnswers = {}; // Lưu đáp án đã chọn cho từng câu hỏi

function parseCSV(text, setName){
    const lines = text.trim().split("\n");
    const questions = [];
    for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim());
        if(cols.length<5) continue;
        questions.push({
            q: cols[0],
            options: [
                {key:"A", text: cols[1]},
                {key:"B", text: cols[2]},
                {key:"C", text: cols[3]}
            ],
            answer: cols[4]
        });
    }
    questionBanks[setName] = questions;
}

// Load tất cả CSV tự động
async function loadAllCSV() {
    try {
        const res = await fetch("csv/list.json");
        if(!res.ok) throw new Error("Cannot load list.json");
        const files = await res.json();
        for(let f of files){
            const text = await (await fetch(`csv/${f}`)).text();
            parseCSV(text, f.replace('.csv',''));
        }
        renderSets();
        updateEndQuestion();
        renderQuestions();
    } catch(e) {
        console.error(e);
    }
}

// Gọi khi mở trang
loadAllCSV();

// ======================= Functions =======================
function toggleBox(id){document.getElementById(id).classList.toggle("collapsed");}

function updateEndQuestion() {
  const selectedSets = Array.from(document.querySelectorAll('#setsBox input:checked')).map(cb => cb.value);
  let total = 0;
  selectedSets.forEach(set => total += (questionBanks[set] || []).length);

  const startInput = document.getElementById('startQ');
  const endInput = document.getElementById('endQ');

  let start = parseInt(startInput.value) || 1;
  let end = parseInt(endInput.value) || start;

  // Giới hạn start
  if (start < 1) start = 1;
  if (start > total) start = total;
  startInput.value = start;

  // Giới hạn end
  if (end < start) end = start;
  if (end > total) end = total;
  endInput.min = start;
  endInput.max = total;
  endInput.value = end;
}

function renderSets(){
  const container=document.getElementById('setsBox'); 
  container.innerHTML="";
  Object.keys(questionBanks).forEach(set=>{
    const lbl=document.createElement("label"); 
    lbl.className="checkbox-level2";
    // Thêm số câu vào tên set
    lbl.innerHTML=`<input type="checkbox" value="${set}"> ${set} (${questionBanks[set].length} questions)`;
    lbl.onclick=()=>updateEndQuestion();
    container.appendChild(lbl);
  });
}

// ======================= Import CSV Function =======================
function importCSVFile(){
  const fileInput = document.getElementById('importCsvInput');
  if(fileInput.files.length===0){ alert("Please select a CSV file."); return; }
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    // Lấy tên file không bao gồm đường dẫn
    let fileName = file.name.replace(/\.[^/.]+$/, ""); // bỏ phần mở rộng .csv
    const setName = fileName || ("Imported Set " + new Date().getTime());
    parseCSV(text,setName);   // dùng hàm parseCSV hiện tại, giữ nguyên logic
    renderSets();             // cập nhật danh sách checkbox
    updateEndQuestion();      // cập nhật end/start
    alert("Imported CSV as: " + setName);
  };
  reader.readAsText(file);
}

// ======================= Render Questions =======================
function renderQuestions() {
  const fixedMode = document.getElementById('fixedMode').checked;
  const instantMode = document.getElementById('instantMode').checked;
  const showOnly = document.getElementById('showFlaggedOnly').checked;

  const selectedSets = Array.from(document.querySelectorAll('#setsBox input:checked')).map(cb => cb.value);
  let allQuestions = [];
  selectedSets.forEach(set => allQuestions = allQuestions.concat(questionBanks[set] || []));

  let shown = [];
  let totalQuestions = allQuestions.length;
  let start = parseInt(document.getElementById('startQ').value) || 1;
  let end = parseInt(document.getElementById('endQ').value) || totalQuestions;
  let numInput = document.getElementById('numQ');
  let num = parseInt(numInput.value) || totalQuestions;
  // Clamp start/end
  if (start < 1) start = 1;
  if (end > totalQuestions) end = totalQuestions;
  if (end < start) end = start;
  numInput.value = num;

    if (showOnly) {
      // Khi flagged only, luôn hiển thị tất cả các câu đã flag (không giới hạn start/end/num)
      let flagged = allQuestions.filter(q => flagStates[q.q]);
      shown = flagged.length > 1 ? [...flagged].sort(() => Math.random() - 0.5) : flagged;
    } else {
      // Luôn lấy theo thứ tự gốc, không shuffle!
      shown = allQuestions.slice(start - 1, end).slice(0, num);
  }

  // Cập nhật số câu hiển thị / tổng số câu
  const countDiv = document.getElementById('questionCount');
  countDiv.innerText = `Showing ${shown.length} / ${allQuestions.length} questions`;

  const container = document.getElementById('questions');
  container.innerHTML = "";

  shown.forEach((q, i) => {
    const div = document.createElement("div");
    div.className = "question";

    const isFlagged = flagStates[q.q] || false;
    const flagDiv = document.createElement("div");
    flagDiv.className = "flag-container";
    flagDiv.style.float = "left";
    flagDiv.style.marginRight = "10px";
    flagDiv.innerHTML = `<span class="flag-round${isFlagged ? ' flag-active' : ''}" style="cursor:pointer;"><input type="checkbox" class="flag-checkbox" ${isFlagged ? "checked" : ""} style="display:none;"><span style="font-size:1.05em; color:#eab308;">&#x1F6A9;</span></span>`;
    const round = flagDiv.querySelector('.flag-round');
    const checkbox = flagDiv.querySelector('input');
    round.onclick = () => {
      checkbox.checked = !checkbox.checked;
      flagStates[q.q] = checkbox.checked;
      renderQuestions();
    };
    checkbox.onchange = (e) => {
      flagStates[q.q] = e.target.checked;
      renderQuestions();
    };
    div.appendChild(flagDiv);

    const qText = document.createElement("p");
    qText.style.marginLeft = "2.5em";
    qText.innerText = `Q${i + 1}: ${q.q}`;
    div.appendChild(qText);

    let opts = [...q.options];
  // Chỉ shuffle đáp án khi ở chế độ flagged only (showOnly)
  let renderOpts = showOnly ? [...opts].sort(() => Math.random() - 0.5) : opts;
    renderOpts.forEach(opt => {
      const optDiv = document.createElement("label");
      optDiv.className = "option";
      const markDiv = document.createElement("span");
      markDiv.className = "option-mark";
      optDiv.appendChild(markDiv);
      // Nếu đã chọn đáp án thì checked
      const checked = selectedAnswers[q.q] === opt.key ? "checked" : "";
      const radio = document.createElement("input");
      radio.type = "radio";
      radio.name = `q_${q.q}`;
      radio.value = opt.key;
      if (checked) radio.checked = true;
      optDiv.appendChild(radio);
      const textSpan = document.createElement("span");
      textSpan.textContent = ` ${opt.text}`;
      optDiv.appendChild(textSpan);
      optDiv.onclick = () => {
        selectedAnswers[q.q] = opt.key;
        handleAnswer(optDiv, opt.key, q.answer, i);
      };
      // Nếu đã chọn đáp án thì tự động highlight đúng/sai
      if (selectedAnswers[q.q]) {
        if (selectedAnswers[q.q] === opt.key && selectedAnswers[q.q] === q.answer) {
          optDiv.classList.add("correct");
        } else if (selectedAnswers[q.q] === opt.key && selectedAnswers[q.q] !== q.answer) {
          optDiv.classList.add("wrong");
        } else if (opt.key === q.answer && selectedAnswers[q.q] !== q.answer && selectedAnswers[q.q] !== undefined) {
          // Nếu đã chọn sai thì vẫn highlight đáp án đúng
          optDiv.classList.add("correct");
        }
      }
      div.appendChild(optDiv);
    });

    container.appendChild(div);
  });
}

// Buttons: không reset flagStates khi refresh hoặc show all
function showAllQuestions(){
  // Lấy các set đang chọn
  const selectedSets = Array.from(document.querySelectorAll('#setsBox input:checked')).map(cb => cb.value);
  
  // Tính tổng số câu của các set được chọn
  let total = 0;
  selectedSets.forEach(set => total += (questionBanks[set] || []).length);

  // Cập nhật start, end, num
  document.getElementById('startQ').value = 1;    // start = 1
  document.getElementById('endQ').value = total;  // end = tổng số câu
  document.getElementById('numQ').value = total;  // num = tổng số câu
  selectedAnswers = {}; // reset đáp án đã chọn
  renderQuestions();
}

function refreshQuestions(){
  // Chỉ xóa đáp án đã chọn, giữ nguyên số lượng câu hỏi đang hiển thị
  selectedAnswers = {};
  renderQuestions();
}

// ======================= Answer Handling =======================
function handleAnswer(optDiv,choiceKey,answerKey,index){
  const instant = document.getElementById('instantMode').checked;
  const parent = optDiv.parentNode;
  [...parent.querySelectorAll(".option")].forEach(o=>o.classList.remove("correct","wrong"));
  if(instant){
    if(choiceKey===answerKey) optDiv.classList.add("correct");
    else{
      optDiv.classList.add("wrong");
      const correctOpt=[...parent.querySelectorAll(".option")].find(o=>o.querySelector("input").value===answerKey);
      if(correctOpt) correctOpt.classList.add("correct");
    }
  }
}

// ======================= Buttons =======================


// Đảm bảo refresh xóa mọi đáp án đã chọn
function refreshQuestions(){
  selectedAnswers = {};
  renderQuestions();
}
function loadSelectedSets(){
  // Lấy các set đang chọn
  const selectedSets = Array.from(document.querySelectorAll('#setsBox input:checked')).map(cb => cb.value);
  
  // Gộp toàn bộ câu của các set được chọn
  allQuestions = [];
  selectedSets.forEach(set => allQuestions = allQuestions.concat(questionBanks[set] || []));

  // Cập nhật start, end, num
  document.getElementById('startQ').value = 1;
  document.getElementById('endQ').value = allQuestions.length;
  document.getElementById('numQ').value = allQuestions.length;

  renderQuestions();
}
function clearAllFlags(){Object.keys(flagStates).forEach(k=>flagStates[k]=false); renderQuestions();}

function exportFlagged(){
  // Lấy danh sách câu hỏi đã flag từ flagStates
  const flaggedQs = [];
  Object.keys(flagStates).forEach(qText => {
    if(flagStates[qText]) {
      // Tìm câu hỏi gốc trong questionBanks
      let found = null;
      for(const set in questionBanks) {
        found = questionBanks[set].find(q => q.q === qText);
        if(found) break;
      }
      if(found) {
        // Export đúng thứ tự A B C và đáp án là key (A/B/C)
        const options = ["A","B","C"].map(k => {
          const o = found.options.find(opt => opt.key === k);
          return o ? o.text : "";
        });
        flaggedQs.push([found.q, ...options, found.answer]);
      }
    }
  });

  if(flaggedQs.length===0){alert("No flagged questions."); return;}

  let csv="Question,Option A,Option B,Option C,Answer\n";
  flaggedQs.forEach(row=>{ csv+=row.map(x=>`"${x}"`).join(",")+"\n"; });

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="flagged_questions.csv"; a.click();
  URL.revokeObjectURL(url);
}

// ======================= Initialize =======================
document.getElementById('startQ').value = 1;
document.getElementById('numQ').value = 1;
</script>

</body>
</html>
