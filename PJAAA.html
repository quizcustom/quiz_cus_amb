<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>Quiz Practice - 4 Sets</title>
<style>
.checkbox-level2 input[type="checkbox"] {
  transition: transform 0.2s;
}
/* Ngăn scale khi tap trên mobile */
.checkbox-level2 input[type="checkbox"]:active {
  transform: none !important;
}
 
body { font-family: Arial, sans-serif; display: flex; justify-content: center; padding: 20px; background: #f9fafb; }
.container { width: 80%; max-width: 700px; }
.box-level1 { border: 2px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px; background: #fff; }
.box-level1 h2 { margin: 0 0 10px 0; font-size: 18px; cursor: pointer; user-select: none; }
.box-content { margin-top: 10px; }
.checkbox-level2 { display: block; width: 100%; padding: 8px 12px; margin: 4px 0; border: 1px solid #aaa; border-radius: 20px; cursor: pointer; transition: all 0.2s; box-sizing: border-box; }
/* .checkbox-level2:hover { transform: scale(0.995); background-color: #f1f5f9; } */
.controls-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
.controls-row label { margin-right: 10px; }
.button-row { display: flex; justify-content: space-between; margin: 10px 0; gap: 10px; flex-wrap: wrap; }
button { padding: 6px 14px; border: none; border-radius: 8px; cursor: pointer; background: #2563eb; color: white; font-weight: bold; }
button:hover { background: #1e40af; }
.question { margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.question p { font-weight: bold; margin: 0 0 10px 0; }
.option { display: block; margin: 6px 0; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
.option input[type="radio"] { margin-right: 10px; }
.option:hover { background: #f1f5f9; }
.option.correct { background: #d1fae5; border: 1px solid #10b981; }
.option.wrong { background: #fee2e2; border: 1px solid #ef4444; }
.collapsible { max-height: 200px; overflow-y: auto; transition: max-height 0.3s ease; }
.collapsed { display: none; }
.flag-checkbox { margin-right: 10px; cursor: pointer; }
.flag-container { margin-bottom: 10px; display: flex; align-items: center; }

@media (max-width: 600px) {
  body { padding: 4px; }
  .container { width: 100%; max-width: 100vw; padding: 0 2vw; }
  .box-level1 { padding: 4px 4px 8px 4px; border-radius: 7px; }
  .box-level1 h2 { font-size: 20px; }
  .checkbox-level2 { font-size: 18px; padding: 12px 8px; }
  .checkbox-level2 input[type="checkbox"] {
    min-width: 28px;
    min-height: 28px;
    width: 28px;
    height: 28px;
  }
  .controls-row label, .controls-row input {
    font-size: 18px;
  }
  .controls-row input[type="number"] {
    padding: 6px;
    width: 60px;
  }
  button {
    font-size: 18px;
    padding: 10px 18px;
  }
  .question { padding: 10px; font-size: 18px; }
  .option { font-size: 18px; padding: 12px; }
  .option input[type="radio"] {
    width: 22px;
    height: 22px;
  }
  #questionCount { font-size: 18px; }
}

@media (pointer: coarse) {
  /* Tăng kích thước checkbox trên mobile */
  .checkbox-level2 input[type="checkbox"] {
    min-width: 24px;
    min-height: 24px;
  }

  /* Vẫn giữ transform none khi active */
  .checkbox-level2 input[type="checkbox"]:active {
    transform: none !important;
  }
}
  
  
</style>
</head>
<body>
<div class="container">

  <!-- Question Sets -->
  <div class="box-level1">

    <h2 onclick="toggleBox('setsBox')">Question Sets ▼</h2>
    <div id="setsBox" class="box-content collapsible"></div>
    <div class="button-row">
      <button onclick="loadSelectedSets()">Load Selected Set</button>
      <!-- Import CSV -->
      <input type="file" id="importCsvInput" accept=".csv" style="margin-top:10px;">
      <button onclick="importCSVFile()" style="margin-top:5px;">Import CSV</button>

    </div>
  </div>

  <!-- Question Range Selection -->
  <div class="box-level1">
    <h2>Question Range Selection</h2>
    <label class="checkbox-level2"><input type="checkbox" id="fixedMode"> Fixed Mode</label>
    <label class="checkbox-level2"><input type="checkbox" id="instantMode"> Instant Check Mode</label>
    <div class="controls-row">
      <label>Start Question: <input type="number" id="startQ" value="1" min="1"></label>
      <label>End Question: <input type="number" id="endQ" value="1" min="1"></label>
      <label>Num. Questions: <input type="number" id="numQ" value="1" min="1"></label>
    </div>
    <div class="button-row">
      <button onclick="showAllQuestions()">All Questions</button>
      <button onclick="refreshQuestions()">Refresh</button>
    </div>
  </div>

  <!-- Flag Controls -->
  <div class="box-level1">
    <h2>Flag Controls</h2>
    <label class="checkbox-level2"><input type="checkbox" id="showFlaggedOnly" onchange="renderQuestions()"> Show Flagged Only</label>
    <div class="button-row">
      <button onclick="exportFlagged()">Export Flagged Questions</button>
      <button onclick="clearAllFlags()">Clear All Flags</button>
    </div>
  </div>
  <div id="questionCount" style="margin-top:5px; font-weight:bold;"></div>

  <!-- Questions Display -->
  <div id="questions"></div>
</div>


<script>
// ======================= Load CSV from files =======================
let questionBanks = {};
let flagStates = {};

function parseCSV(text, setName){
    const lines = text.trim().split("\n");
    const questions = [];
    for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g,'').trim());
        if(cols.length<5) continue;
        questions.push({
            q: cols[0],
            options: [
                {key:"A", text: cols[1]},
                {key:"B", text: cols[2]},
                {key:"C", text: cols[3]}
            ],
            answer: cols[4]
        });
    }
    questionBanks[setName] = questions;
}

// Load tất cả CSV tự động
async function loadAllCSV() {
    try {
        const res = await fetch("csv/list.json");
        if(!res.ok) throw new Error("Cannot load list.json");
        const files = await res.json();
        for(let f of files){
            const text = await (await fetch(`csv/${f}`)).text();
            parseCSV(text, f.replace('.csv',''));
        }
        renderSets();
        updateEndQuestion();
        renderQuestions();
    } catch(e) {
        console.error(e);
    }
}

// Gọi khi mở trang
loadAllCSV();

// ======================= Functions =======================
function toggleBox(id){document.getElementById(id).classList.toggle("collapsed");}

function updateEndQuestion() {
  const selectedSets = Array.from(document.querySelectorAll('#setsBox input:checked')).map(cb => cb.value);
  let total = 0;
  selectedSets.forEach(set => total += (questionBanks[set] || []).length);

  const startInput = document.getElementById('startQ');
  const endInput = document.getElementById('endQ');

  let start = parseInt(startInput.value) || 1;
  let end = parseInt(endInput.value) || start;

  // Giới hạn start
  if (start < 1) start = 1;
  if (start > total) start = total;
  startInput.value = start;

  // Giới hạn end
  if (end < start) end = start;
  if (end > total) end = total;
  endInput.min = start;
  endInput.max = total;
  endInput.value = end;
}

function renderSets(){
  const container=document.getElementById('setsBox'); 
  container.innerHTML="";
  Object.keys(questionBanks).forEach(set=>{
    const lbl=document.createElement("label"); 
    lbl.className="checkbox-level2";
    // Thêm số câu vào tên set
    lbl.innerHTML=`<input type="checkbox" value="${set}"> ${set} (${questionBanks[set].length} questions)`;
    lbl.onclick=()=>updateEndQuestion();
    container.appendChild(lbl);
  });
}

// ======================= Import CSV Function =======================
function importCSVFile(){
  const fileInput = document.getElementById('importCsvInput');
  if(fileInput.files.length===0){ alert("Please select a CSV file."); return; }
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    // Lấy tên file không bao gồm đường dẫn
    let fileName = file.name.replace(/\.[^/.]+$/, ""); // bỏ phần mở rộng .csv
    const setName = fileName || ("Imported Set " + new Date().getTime());
    parseCSV(text,setName);   // dùng hàm parseCSV hiện tại, giữ nguyên logic
    renderSets();             // cập nhật danh sách checkbox
    updateEndQuestion();      // cập nhật end/start
    alert("Imported CSV as: " + setName);
  };
  reader.readAsText(file);
}

// ======================= Render Questions =======================
function renderQuestions() {
  const fixedMode = document.getElementById('fixedMode').checked;
  const instantMode = document.getElementById('instantMode').checked;
  const showOnly = document.getElementById('showFlaggedOnly').checked;

  const selectedSets = Array.from(document.querySelectorAll('#setsBox input:checked')).map(cb => cb.value);
  allQuestions = [];
  selectedSets.forEach(set => allQuestions = allQuestions.concat(questionBanks[set] || []));
  if (!fixedMode) allQuestions.sort(() => Math.random() - 0.5);

  let shown = [];
  if (showOnly) {
    shown = allQuestions.filter(q => flagStates[q.q]);
  } else {
    const start = parseInt(document.getElementById('startQ').value) || 1;
    const end = parseInt(document.getElementById('endQ').value) || allQuestions.length;
    let numInput = document.getElementById('numQ');
    let num = parseInt(numInput.value) || allQuestions.length;
    if (num > end - start + 1) num = end - start + 1;
    numInput.value = num; // cập nhật input hiển thị
    shown = allQuestions.slice(start - 1, end).slice(0, num);
  }

  // Cập nhật số câu hiển thị / tổng số câu
  const countDiv = document.getElementById('questionCount');
  countDiv.innerText = `Showing ${shown.length} / ${allQuestions.length} questions`;

  const container = document.getElementById('questions');
  container.innerHTML = "";

  shown.forEach((q, i) => {
    const div = document.createElement("div");
    div.className = "question";

    const isFlagged = flagStates[q.q] || false;
    const flagDiv = document.createElement("div");
    flagDiv.className = "flag-container";
    flagDiv.innerHTML = `<input type="checkbox" class="flag-checkbox" ${isFlagged ? "checked" : ""}> <span>Flag</span>`;
    flagDiv.querySelector("input").onchange = (e) => {
      flagStates[q.q] = e.target.checked;
      if (document.getElementById('showFlaggedOnly').checked) renderQuestions();
    };
    div.appendChild(flagDiv);

    const qText = document.createElement("p");
    qText.innerText = `Q${i + 1}: ${q.q}`;
    div.appendChild(qText);

    let opts = [...q.options];
    if (!fixedMode) opts.sort(() => Math.random() - 0.5);
    opts.forEach(opt => {
      const optDiv = document.createElement("label");
      optDiv.className = "option";
      optDiv.innerHTML = `<input type="radio" name="q${i}" value="${opt.key}"> ${opt.text}`;
      optDiv.onclick = () => handleAnswer(optDiv, opt.key, q.answer, i);
      div.appendChild(optDiv);
    });

    container.appendChild(div);
  });
}

// Buttons: không reset flagStates khi refresh hoặc show all
function showAllQuestions(){
  // Lấy các set đang chọn
  const selectedSets = Array.from(document.querySelectorAll('#setsBox input:checked')).map(cb => cb.value);
  
  // Tính tổng số câu của các set được chọn
  let total = 0;
  selectedSets.forEach(set => total += (questionBanks[set] || []).length);

  // Cập nhật start, end, num
  document.getElementById('startQ').value = 1;    // start = 1
  document.getElementById('endQ').value = total;  // end = tổng số câu
  document.getElementById('numQ').value = total;  // num = tổng số câu

  renderQuestions();
}

function refreshQuestions(){
  renderQuestions();
}

// ======================= Answer Handling =======================
function handleAnswer(optDiv,choiceKey,answerKey,index){
  const instant = document.getElementById('instantMode').checked;
  const parent = optDiv.parentNode;
  [...parent.querySelectorAll(".option")].forEach(o=>o.classList.remove("correct","wrong"));
  if(instant){
    if(choiceKey===answerKey) optDiv.classList.add("correct");
    else{
      optDiv.classList.add("wrong");
      const correctOpt=[...parent.querySelectorAll(".option")].find(o=>o.querySelector("input").value===answerKey);
      if(correctOpt) correctOpt.classList.add("correct");
    }
  }
}

// ======================= Buttons =======================


function refreshQuestions(){renderQuestions();}
function loadSelectedSets(){
  // Lấy các set đang chọn
  const selectedSets = Array.from(document.querySelectorAll('#setsBox input:checked')).map(cb => cb.value);
  
  // Gộp toàn bộ câu của các set được chọn
  allQuestions = [];
  selectedSets.forEach(set => allQuestions = allQuestions.concat(questionBanks[set] || []));

  // Cập nhật start, end, num
  document.getElementById('startQ').value = 1;
  document.getElementById('endQ').value = allQuestions.length;
  document.getElementById('numQ').value = allQuestions.length;

  renderQuestions();
}
function clearAllFlags(){Object.keys(flagStates).forEach(k=>flagStates[k]=false); renderQuestions();}

function exportFlagged(){
  const flaggedQs=[];
  document.querySelectorAll(".question").forEach(div=>{
    const flagCheckbox=div.querySelector(".flag-checkbox");
    if(flagCheckbox && flagCheckbox.checked){
      const qText=div.querySelector("p").innerText.replace(/^Q\d+: /,"");
      const options=[...div.querySelectorAll(".option input")].map(inp=>inp.parentNode.textContent.trim());
      const answer=[...div.querySelectorAll(".option input")].find(inp=>inp.parentNode.classList.contains("correct"));
      const ansKey=answer?answer.value:"";
      flaggedQs.push([qText,...options,ansKey]);
    }
  });

  if(flaggedQs.length===0){alert("No flagged questions."); return;}

  let csv="Question,Option A,Option B,Option C,Answer\n";
  flaggedQs.forEach(row=>{ csv+=row.map(x=>`"${x}"`).join(",")+"\n"; });

  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="flagged_questions.csv"; a.click();
  URL.revokeObjectURL(url);
}

// ======================= Initialize =======================
document.getElementById('startQ').value = 1;
document.getElementById('numQ').value = 1;
</script>
</body>
</html>
